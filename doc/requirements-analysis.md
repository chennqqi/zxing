# 需求分析

## 2023-10-27: 检查并修复workflows中的问题

### 1. 需求理解
用户要求检查并修复 `.github/workflows/` 目录下的所有工作流文件。

### 2. 问题分析
通过检查 `benchmark.yml`, `build.yml`, 和 `release.yml` 文件，发现以下主要问题：

1.  **`benchmark.yml`**:
    -   基准测试的对比功能已损坏。它尝试将当前结果与本地一个从未被创建过的历史报告文件进行比较，导致对比永远不会发生。
    -   构件（artifact）上传策略效率低下，上传了整个结果目录而非仅上传必要的报告文件，增加了存储和下载的负担。

2.  **`build.yml`**:
    -   包含冗余和可以合并的依赖安装步骤。
    -   测试步骤中存在不必要的 `if` 条件判断。
    -   `release` 任务中的构件下载逻辑是错误的，使用了无效的参数，无法正确下载用于发布的包。

3.  **`release.yml`**:
    -   此文件的功能与 `build.yml` 中的发布功能严重重叠。
    -   当一个新标签被推送到仓库时，`build.yml` 和 `release.yml` 会被同时触发，并尝试创建同一个 GitHub Release，这会导致竞态条件（race condition），其中一个工作流必然会因为版本已存在而失败。

### 3. 解决方案
为了解决以上问题，并优化CI/CD流程，制定了以下修复方案：

1.  **整合与删除**:
    -   将 `release.yml` 中有用的逻辑（构建和上传二进制库文件）合并到 `build.yml` 中。
    -   删除 `release.yml` 文件，从根本上消除竞态条件和功能冗余。

2.  **修复 `benchmark.yml`**:
    -   重构基准测试对比步骤。增加一个步骤，使用 `dawidd6/action-download-artifact` 操作从 `main` 分支的最新成功流程中下载历史基准报告。
    -   修改对比脚本，使其能够正确地与新下载的报告进行 `diff` 操作。
    -   优化构件上传步骤，使其仅上传生成的 `.md` 报告文件。

3.  **修复并增强 `build.yml`**:
    -   **合并功能**: 将 `release.yml` 的二进制文件构建逻辑添加进来。现在 `build` 任务也会生成 `.so`, `.dll`, `.dylib` 文件并将它们作为构件上传。
    -   **清理与优化**: 合并了多个重复的依赖安装步骤，并简化了测试步骤的脚本。
    -   **修复发布流程**:
        -   完全重构 `release` 任务。
        -   添加了多个下载步骤，以正确地拉取所有需要的构件（`.deb` 包, `.rpm` 包, 以及所有平台的二进制库文件）。
        -   在创建 Release 之前，增加了一个准备步骤，用于重命名二进制文件以符合发布规范。
        -   最终，使用 `softprops/action-gh-release` 操作将所有准备好的文件一次性、原子地上传到一个统一的 GitHub Release 中。

通过以上修改，工作流变得更加健壮、高效且易于维护。 